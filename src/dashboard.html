<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>USA Fatal Accidents Insight</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
<div class="dashboard-container">
    <header>
        <h1>USA FATAL ACCIDENTS INSIGHT</h1>
    </header>

    <form id="filter-form">
        <div class="filters">
            <div class="date-range">
                <label for="from-year">From year</label>
                <input type="number" id="from-year" name="from-year" min="2010" max="2022" required>
                <span>-</span>
                <label for="to-year">To year</label>
                <input type="number" id="to-year" name="to-year" min="2010" max="2022" required>
            </div>

            <div class="state-selector">
                <label for="state">STATE</label>
                <select id="state" name="state">
                    <option value="">All States</option>
                    <option value="CA">California</option>
                    <option value="TX">Texas</option>
                    <option value="FL">Florida</option>
                </select>
            </div>

            <button type="submit" class="submit-button">Submit</button>
        </div>
    </form>
    <div class="export-container">
        <h2>Export Data</h2>
        <button onclick="exportData('csv')">Export as CSV</button>
        <button onclick="exportData('webp')">Export as WebP Image</button>
    </div>
    <div class="stats-container">
        <div class="stat-box">
            <h2>FATAL ACCIDENTS (TOTAL)</h2>
            <div class="stat-value" id="total-accidents">0</div>
            <div class="chart-container">
                <canvas id="accidents-chart"></canvas>
            </div>
        </div>

        <div class="stat-box">
            <h2>CASUALTIES (TOTAL)</h2>
            <div class="stat-value" id="total-casualties">0</div>
            <div class="chart-container">
                <canvas id="casualties-chart"></canvas>
            </div>
        </div>

        <div class="stat-box">
            <h2>AVG CASUALTIES / ACCIDENT</h2>
            <div class="stat-value" id="avg-casualties">0</div>
            <div class="chart-container">
                <canvas id="avg-casualties-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="map-container">
        <h2>MAP</h2>
        <div id="map"></div>
    </div>
</div>

<script>
    // Initialize form values
    const today = new Date();
    const thisYear = today.getFullYear();
    const lastYear = thisYear - 1;
    document.getElementById('from-year').value = lastYear;
    document.getElementById('to-year').value = thisYear;

    // Initialize map
    const map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let markersGroup = L.layerGroup().addTo(map);

    // Initialize charts
    const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
    const accidentsChart = new Chart(document.getElementById('accidents-chart'), {
        type: 'bar', data: { labels: ['Accidents'], datasets: [{ data: [0], backgroundColor: 'rgba(54,162,235,0.5)' }] },
        options: chartOptions
    });
    const casualtiesChart = new Chart(document.getElementById('casualties-chart'), {
        type: 'bar', data: { labels: ['Casualties'], datasets: [{ data: [0], backgroundColor: 'rgba(255,99,132,0.5)' }] },
        options: chartOptions
    });
    const avgCasualtiesChart = new Chart(document.getElementById('avg-casualties-chart'), {
        type: 'bar', data: { labels: ['Avg Casualties'], datasets: [{ data: [0], backgroundColor: 'rgba(75,192,192,0.5)' }] },
        options: chartOptions
    });

    // AJAX handler
    document.getElementById('filter-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const fromYear = document.getElementById('from-year').value;
        const toYear = document.getElementById('to-year').value;
        const state = document.getElementById('state').value;

        // Get statistics
        fetch(`api/statistics.php?from_year=${fromYear}&to_year=${toYear}&state=${state}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('total-accidents').textContent = data.accidents;
                document.getElementById('total-casualties').textContent = data.casualties;
                document.getElementById('avg-casualties').textContent = data.avg_casualties.toFixed(2);

                accidentsChart.data.datasets[0].data = [data.accidents];
                accidentsChart.update();

                casualtiesChart.data.datasets[0].data = [data.casualties];
                casualtiesChart.update();

                avgCasualtiesChart.data.datasets[0].data = [data.avg_casualties];
                avgCasualtiesChart.update();
            });

        // Get map data
        fetch(`api/mapdata.php?from_year=${fromYear}&to_year=${toYear}&state=${state}`)
            .then(res => res.json())
            .then(data => {
                markersGroup.clearLayers();
                const points = data.points.map(p => L.circle([p.lat, p.lng], {
                    radius: p.weight * 1000,
                    color: 'red',
                    fillOpacity: 0.5
                }));
                points.forEach(marker => marker.addTo(markersGroup));
                if (points.length) {
                    const group = new L.featureGroup(points);
                    map.fitBounds(group.getBounds());
                }
            });
    });
    function exportData(format) {
        const fromYear = document.getElementById('from-year').value;
        const toYear = document.getElementById('to-year').value;
        const state = document.getElementById('state').value;

        const url = `api/export.php?from_year=${fromYear}&to_year=${toYear}&state=${state}&format=${format}`;
        window.open(url, '_blank');
    }
</script>
</body>
</html>
